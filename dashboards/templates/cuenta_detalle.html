{% extends "base.html" %}
{% load static %}

{% block title %}Detalle de la cuenta{% endblock %}

{% block content %}
<h2>{{ cuenta.nombre }}</h2>
<p>{{ cuenta.descripcion }}</p>
<p><strong>Balance:</strong> ${{ balance }}</p>

<button type="button" onclick="abrirModal()">Agregar movimiento</button>

<div id="movimientoModal" class="modal" style="display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content" style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px;">
        <span class="close" onclick="cerrarModal()" style="float: right; cursor: pointer;">&times;</span>
        <h3 id="modalTitle">Agregar Movimiento</h3>
        <form method="post" id="movimientoForm">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit">Guardar</button>
        </form>
    </div>
</div>

<table border="1">
  <tr>
    <th>Fecha</th>
    <th>Concepto</th>
    <th>Tipo</th>
    <th>Monto</th>
  </tr>
  {% for mov in movimientos %}
      {% if mov.tipo == 'INGRESO' %}
        <tr style="background-color: #d4edda;">
          <td>{{ mov.fecha }}</td>
          <td>{{ mov.concepto }}</td>
          <td>{{ mov.tipo }}</td>
          <td>${{ mov.monto }}</td>
      {% else %}
        <tr style="background-color: #f8d7da;">
          <td>{{ mov.fecha }}</td>
          <td>{{ mov.concepto }}</td>
          <td>{{ mov.tipo }}</td>
          <td>$-{{ mov.monto }}</td>
      {% endif %}
          <td>
            <button onclick="editarMovimiento('{{ mov.id }}', '{{ mov.concepto }}', '{{ mov.tipo }}', '{{ mov.monto }}', '{{ mov.fecha|date:'Y-m-d' }}')" style="margin-right: 5px;">editar</button>
            <form method="post"
            action="{% url 'dashboards:eliminar_movimiento' cuenta.id mov.id %}"
            style="display:inline;"
            onsubmit="return confirmarEliminacion(event)">
              {% csrf_token %}
              <button type="submit" style="color:red;">X</button>
            </form>
          </td>
        </tr>
  {% empty %}
  <tr><td colspan="3">No hay movimientos aún.</td></tr>
  {% endfor %}
</table>

<a href="{% url 'dashboards:lista_cuentas' %}">Volver</a>

<script>
function confirmarEliminacion(event) {
    event.preventDefault();
    const confirmacion = confirm("¿Seguro que deseas eliminar este movimiento?");
    if (confirmacion) {
        event.target.submit();
    }
}

function abrirModal() {
    document.getElementById('movimientoModal').style.display = 'block';
    document.getElementById('modalTitle').textContent = 'Agregar Movimiento';
    document.getElementById('movimientoForm').setAttribute('action', '{% url "dashboards:agregar_movimiento" cuenta.id %}');
}

function cerrarModal() {
    document.getElementById('movimientoModal').style.display = 'none';
    document.getElementById('movimientoForm').reset();
}

function editarMovimiento(id, concepto, tipo, monto, fecha) {
    document.getElementById('movimientoModal').style.display = 'block';
    document.getElementById('modalTitle').textContent = 'Editar Movimiento';
    
    // Actualizar el formulario con los datos existentes
    document.getElementById('id_concepto').value = concepto;
    document.getElementById('id_tipo').value = tipo;
    document.getElementById('id_monto').value = monto;
    document.getElementById('id_fecha').value = fecha;
    
    // Cambiar la URL del formulario para edición
    document.getElementById('movimientoForm').setAttribute('action', 
        '{% url "dashboards:detalle_cuenta" cuenta.id %}' + 'editar-movimiento/' + id + '/');
}

// Cerrar modal si se hace clic fuera de él
window.onclick = function(event) {
    if (event.target == document.getElementById('movimientoModal')) {
        cerrarModal();
    }
}
</script>
{% endblock %}